const originalLang=document.documentElement.lang,ttsLang=getTTSLang(),categories=[...document.getElementById("courseOption").options].map(a=>a.value.toLowerCase()),problems={};let englishVoices=[];const audioContext=new AudioContext,audioBufferCache={};loadAudio("correct","/emoji-concentration/mp3/correct3.mp3"),loadAudio("correctAll","/emoji-concentration/mp3/correct1.mp3"),loadAudio("incorrect","/emoji-concentration/mp3/incorrect1.mp3"),loadConfig();function loadConfig(){if(localStorage.getItem("darkMode")==1&&(document.documentElement.dataset.theme="dark"),originalLang=="ja")if(localStorage.getItem("furigana")==1){const a=document.getElementById("addFurigana");addFurigana(a),a.setAttribute("data-done",!0)}}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),delete document.documentElement.dataset.theme):(localStorage.setItem("darkMode",1),document.documentElement.dataset.theme="dark")}function addFurigana(){if(originalLang!="ja")return;const a=document.getElementById("addFurigana");a.getAttribute("data-done")?(localStorage.setItem("furigana",0),location.reload()):(import("https://marmooo.github.io/yomico/yomico.min.js").then(a=>{a.yomico("/emoji-concentration/ja/index.yomi")}),localStorage.setItem("furigana",1),a.setAttribute("data-done",!0))}function changeLang(){const a=document.getElementById("lang"),b=a.options[a.selectedIndex].value;location.href=`/emoji-concentration/${b}/`}function getTTSLang(){switch(originalLang){case"en":return"en-US";case"ja":return"ja-JP"}}async function playAudio(b,c){const d=await loadAudio(b,audioBufferCache[b]),a=audioContext.createBufferSource();if(a.buffer=d,c){const b=audioContext.createGain();b.gain.value=c,b.connect(audioContext.destination),a.connect(b),a.start()}else a.connect(audioContext.destination),a.start()}async function loadAudio(a,c){if(audioBufferCache[a])return audioBufferCache[a];const d=await fetch(c),e=await d.arrayBuffer(),b=await audioContext.decodeAudioData(e);return audioBufferCache[a]=b,b}function unlockAudio(){audioContext.resume()}function loadVoices(){const a=new Promise(b=>{let a=speechSynthesis.getVoices();if(a.length!==0)b(a);else{let c=!1;speechSynthesis.addEventListener("voiceschanged",()=>{c=!0,a=speechSynthesis.getVoices(),b(a)}),setTimeout(()=>{c||document.getElementById("noTTS").classList.remove("d-none")},500)}}),b=["com.apple.speech.synthesis.voice.Bahh","com.apple.speech.synthesis.voice.Albert","com.apple.speech.synthesis.voice.Hysterical","com.apple.speech.synthesis.voice.Organ","com.apple.speech.synthesis.voice.Cellos","com.apple.speech.synthesis.voice.Zarvox","com.apple.speech.synthesis.voice.Bells","com.apple.speech.synthesis.voice.Trinoids","com.apple.speech.synthesis.voice.Boing","com.apple.speech.synthesis.voice.Whisper","com.apple.speech.synthesis.voice.Deranged","com.apple.speech.synthesis.voice.GoodNews","com.apple.speech.synthesis.voice.BadNews","com.apple.speech.synthesis.voice.Bubbles"];a.then(a=>{englishVoices=a.filter(a=>a.lang==ttsLang).filter(a=>!b.includes(a.voiceURI))})}loadVoices();function speak(b){speechSynthesis.cancel();const a=new SpeechSynthesisUtterance(b);return a.voice=englishVoices[Math.floor(Math.random()*englishVoices.length)],a.lang=ttsLang,speechSynthesis.speak(a),a}function getRandomInt(a,b){return a=Math.ceil(a),b=Math.floor(b),Math.floor(Math.random()*(b-a)+a)}function shuffle(a){for(let b=a.length;1<b;b--){const c=Math.floor(Math.random()*b);[a[c],a[b-1]]=[a[b-1],a[c]]}return a}function catWalk(g,h,d){const c=document.getElementById("catsWalk"),e=c.offsetWidth,f=c.offsetHeight,a=document.createElement("span");a.className="emoji walker",a.style.position="absolute",a.textContent=h;const b=128;a.style.top=getRandomInt(0,f-b)+"px",a.style.left=e-b+"px",a.addEventListener("click",()=>{speak(d),a.remove()},{once:!0}),c.appendChild(a);const i=setInterval(()=>{const c=parseInt(a.style.left)-1;c>-b?a.style.left=c+"px":(clearInterval(i),a.remove())},g)}function catsWalk(){setInterval(()=>{if(Math.random()>.995){const[a,b]=selectRandomEmoji();catWalk(getRandomInt(5,20),a,b)}},10)}function selectRandomEmoji(a){a||(a=categories[getRandomInt(0,categories.length)]);const b=problems[a],c=b[getRandomInt(0,b.length)],d=c[0],e=d[getRandomInt(0,d.length)],f=c[1];return[e,f]}function showAllHints(){const a=document.getElementById("choices");[...a.getElementsByClassName("text")].forEach(a=>{a.style.visibility="initial"})}function hideAllHints(){const a=document.getElementById("choices");[...a.getElementsByClassName("text")].forEach(a=>{a.style.visibility="hidden"})}function changeMode(a){a.target.textContent=="EASY"?(a.target.textContent="HARD",hideAllHints()):(a.target.textContent="EASY",showAllHints())}function filterBacked(a,b){return b.filter(b=>{const c=b.querySelector(".back");if(!b.classList.contains("cleared")&&c.classList.contains("d-none"))return!0;if(b==a)return!1})}function rotateCardAll(a){a.forEach(a=>{const b=a.querySelector(".front"),c=a.querySelector(".back");rotateCard(b,c)})}function speechOnEnd(c,d,b,a){if(a.length>=2){const c=a.every(a=>{if(a.querySelector(".text").textContent==d)return!0});if(c){const c=b.filter(a=>a.classList.contains("cleared"));c.length==b.length-a.length?playAudio("correctAll"):playAudio("correct"),a.forEach(a=>{a.querySelector(".back").onclick=()=>{},a.classList.add("cleared")})}else playAudio("incorrect"),rotateCardAll(a)}c.parentNode.style.pointerEvents="auto"}function initEvents(){const a=[...document.getElementById("choices").children];a.forEach(b=>{const c=b.querySelector(".front"),d=b.querySelector(".back");c.onclick=()=>{const a=b.querySelector(".text").textContent;speak(a)},d.onclick=()=>{b.parentNode.style.pointerEvents="none";const e=filterBacked(b,a);if(c.classList.contains("d-none")){e.push(b);const c=b.querySelector(".text").textContent,d=speak(c);/(iPad|iPhone|iPod|Macintosh)/.test(navigator.userAgent)?setTimeout(()=>{speechOnEnd(b,c,a,e)},2e3):d.onend=()=>{speechOnEnd(b,c,a,e)}}rotateCard(c,d)}})}function initProblems(){fetch(`/emoji-concentration/data/${originalLang}.csv`).then(a=>a.text()).then(b=>{let a;b.trimEnd().split("\n").forEach(e=>{const[d,b,c,f]=e.split(",");if(b in problems===!1&&(problems[b]=[]),a==c){const a=problems[b],c=a[a.length-1];c[0].push(d)}else problems[b].push([[d],c]);a=c})})}function rotateCard(a,b){function c(a,b){b<=180?(d(a,b),setTimeout(()=>{c(a,b+=5)},1)):a.style.transform=null}function d(c,d){90===d?c==a?(a.classList.add("d-none"),b.classList.remove("d-none")):(a.classList.remove("d-none"),b.classList.add("d-none")):c.style.transform=`rotateY(${d}deg)`}a.classList.contains("d-none")?c(b,0):c(a,0)}function changeLevel(){const e=document.getElementById("levelOption").selectedIndex,a=document.getElementById("choices");while(a.firstChild)a.removeChild(a.firstChild);const c={},f=3+e*2;while(!0)if(Object.keys(c).length<f){const a=document.getElementById("courseOption"),b=categories[a.selectedIndex],[d,e]=selectRandomEmoji(b);c[e]=d}else break;const d=Object.entries(c),b=[];for(let c=0;c<d.length;c++){const e=document.getElementById("choice-box").content.cloneNode(!0),a=e.querySelector(".card"),[f,g]=d[c];a.querySelector(".emoji").textContent=g,a.querySelector(".text").textContent=f,b.push(a),b.push(a.cloneNode(!0))}shuffle(b),b.forEach(b=>a.appendChild(b)),initEvents()}initEvents(),initProblems(),catsWalk(),document.getElementById("toggleDarkMode").onclick=toggleDarkMode;const furiganaButton=document.getElementById("addFurigana");furiganaButton&&(furiganaButton.onclick=addFurigana),document.getElementById("mode").onclick=changeMode,document.getElementById("levelOption").onchange=changeLevel,document.getElementById("courseOption").onchange=changeLevel,document.getElementById("lang").onchange=changeLang,document.addEventListener("click",unlockAudio,{once:!0,useCapture:!0})